<!DOCTYPE html>
<html>
<head>
    <title>æ¼æ°´å£°æ³¢ç›‘æµ‹ä»ª</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { 
            font-family: sans-serif; 
            text-align: center; 
            padding: 20px;
            background: #f0f8ff;
        }
        #myChart {
            max-width: 100%;
            margin: 20px auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            padding: 12px 25px;
            font-size: 16px;
            margin: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        #startBtn { 
            background: #4CAF50; 
            color: white; 
        }
        #stopBtn { 
            background: #f44336; 
            color: white; 
        }
        button:hover {
            opacity: 0.9;
            transform: scale(1.05);
        }
        #status {
            font-weight: bold;
            font-size: 18px;
            margin: 15px 0;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš° æ°´ç®¡æ¼æ°´å£°æ³¢å®æ—¶ç›‘æµ‹ç³»ç»Ÿ</h1>
        <p>çŠ¶æ€ï¼š<span id="status">ç­‰å¾…å¼€å§‹ç›‘å¬...</span></p >
        <canvas id="myChart" width="400" height="200"></canvas>
        <br>
        <button id="startBtn">å¼€å§‹ç›‘å¬</button>
        <button id="stopBtn">åœæ­¢ç›‘å¬</button>
        <p><small>å°†æ‰‹æœºéº¦å…‹é£é è¿‘æ°´ç®¡æˆ–å¬è¯Šå™¨ï¼Œè§‚å¯Ÿæ³¢å½¢å˜åŒ–</small></p >
    </div>

    <script>
        const ctx = document.getElementById('myChart').getContext('2d');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusEl = document.getElementById('status');

        let audioContext;
        let analyser;
        let dataArray;
        let chart;
        let animationId;

        // åˆå§‹åŒ–å›¾è¡¨
        const chartConfig = {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'å£°éŸ³é¢‘ç‡',
                    data: [],
                    borderColor: '#4CAF50',
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: false,
                animation: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 256,
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    },
                    x: {
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true
                    }
                }
            }
        };
        
        chart = new Chart(ctx, chartConfig);

        // å¼€å§‹ç›‘å¬
        startBtn.onclick = async () => {
            statusEl.textContent = "ğŸ¤ ç›‘å¬ä¸­...ï¼ˆè¯·å…è®¸ä½¿ç”¨éº¦å…‹é£ï¼‰";
            statusEl.style.color = "#4CAF50";
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    } 
                });
                
                audioContext = new AudioContext({ sampleRate: 16000 });
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                
                analyser.fftSize = 512;
                analyser.smoothingTimeConstant = 0.8;
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                
                updateChart();
                
            } catch (err) {
                statusEl.textContent = "âŒ æ— æ³•è®¿é—®éº¦å…‹é£: " + err.message;
                statusEl.style.color = "#f44336";
                console.error("éº¦å…‹é£è®¿é—®é”™è¯¯:", err);
            }
        };

        // åœæ­¢ç›‘å¬
        stopBtn.onclick = () => {
            statusEl.textContent = "â¹ï¸ å·²åœæ­¢ç›‘å¬";
            statusEl.style.color = "#666";
            if (audioContext) {
                audioContext.close().catch(console.error);
            }
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        };

        // æ›´æ–°å›¾è¡¨
        function updateChart() {
            if (!analyser) return;
            
            animationId = requestAnimationFrame(updateChart);
            analyser.getByteFrequencyData(dataArray);
            
            const simplifiedData = [];
            const step = Math.floor(dataArray.length / 100);
            
            for (let i = 0; i < dataArray.length; i += step) {
                let sum = 0;
                for (let j = 0; j < step && (i + j) < dataArray.length; j++) {
                    sum += dataArray[i + j];
                }
                simplifiedData.push(sum / step);
            }
            
            chart.data.labels = Array.from({length: simplifiedData.length}, (_, i) => i);
            chart.data.datasets[0].data = simplifiedData;
            chart.update('none');
        }

        // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
        window.addEventListener('beforeunload', () => {
            if (audioContext) {
                audioContext.close().catch(console.error);
            }
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        });
    </script>
</body>
</html>